#!/usr/bin/env bash

# Configuration
LOCAL_DIR="$HOME/.remote"
REMOTE_USER="kaffae"
REMOTE_HOST="192.168.1.100"
REMOTE_PORT="3000"
REMOTE_DIR="/var/www/kodeflowstudios.com"
SSH_KEY="$HOME/.ssh/id_rsa"

# Create local directory if it doesn't exist
mkdir -p "$LOCAL_DIR"

# Function to sync to remote
sync_to_remote() {
    echo "Syncing to remote..."
    rsync -avz --delete -e "ssh -i $SSH_KEY -p $REMOTE_PORT" \
        "$LOCAL_DIR/" "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/"
    
    if [ $? -eq 0 ]; then
        osascript -e "display notification \"Files synced to server\" with title \"Sync Complete\""
    else
        osascript -e "display notification \"Sync failed!\" with title \"Sync Error\""
    fi
}

# Function to sync from remote
sync_from_remote() {
    echo "Syncing from remote..."
    rsync -avz --delete -e "ssh -i $SSH_KEY -p $REMOTE_PORT" \
        "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/" "$LOCAL_DIR/"
    
    if [ $? -eq 0 ]; then
        osascript -e "display notification \"Files synced from server\" with title \"Sync Complete\""
    fi
}

# Menu system
if [ "$1" = "watch" ]; then
    echo "Starting file watcher..."
    echo "Watching $LOCAL_DIR for changes..."
    
    # Initial sync from remote
    sync_from_remote
    
    # Watch for changes and sync
    fswatch -o "$LOCAL_DIR" | while read num; do
        echo "Changes detected, syncing..."
        sync_to_remote
    done
    
elif [ "$1" = "up" ]; then
    sync_to_remote
    
elif [ "$1" = "down" ]; then
    sync_from_remote
    
elif [ "$1" = "edit" ]; then
    # Sync down, open editor, then watch for changes
    sync_from_remote
    cd "$LOCAL_DIR"
    
    # Start watcher in background
    fswatch -o "$LOCAL_DIR" | while read num; do
        sync_to_remote
    done &
    WATCHER_PID=$!
    
    # Open neovim
    nvim .
    
    # Kill watcher when nvim exits
    kill $WATCHER_PID 2>/dev/null
    
else
    echo "Usage: $0 {watch|up|down|edit}"
    echo "  watch - Start continuous sync on file changes"
    echo "  up    - Sync local files to remote"  
    echo "  down  - Sync remote files to local"
    echo "  edit  - Sync down, open nvim, auto-sync changes"
fi
